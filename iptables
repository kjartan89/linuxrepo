#!/bin/bash

# Oppdater pakkelisten
echo "Oppdaterer pakkelisten..."
sudo apt update

# Installer iptables og iptables-persistent
echo "Installerer iptables og iptables-persistent..."
sudo apt install -y iptables iptables-persistent

# Tøm eksisterende regler
iptables -F
iptables -X
iptables -Z

# Sett standard policy til å DROP alt innkommende og videresendt
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# Tillat loopback
iptables -A INPUT -i lo -j ACCEPT

# Tillat etablerte og relaterte tilkoblinger
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Åpne nødvendige porter for tjenester (juster etter behov)
# SSH
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
# Webserver (HTTP og HTTPS)
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# Logging av avviste pakker (valgfritt, for overvåkning)
iptables -A INPUT -j LOG --log-prefix "IPTables-Drop: "

# Lagre reglene for å sikre at de gjenopprettes ved oppstart
echo "Lagrer regler..."
sudo netfilter-persistent save

echo "iptables er konfigurert og regler er lagret."
